<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional Pose Mocap to Roblox</title>
<style>
body {
  margin: 0;
  padding: 0;
  background: #121212;
  font-family: 'Fira Code', monospace;
  color: #e0e0e0;
  overflow: hidden;
}

video, canvas {
  position: absolute;
  top: 0;
  left: 0;
}

#ui {
  position: fixed;
  right: 20px;
  top: 20px;
  width: 380px;
  background: #1f1f1f;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.6);
  padding: 16px;
  z-index: 100;
}

#ui h2 {
  margin: 0 0 12px 0;
  font-size: 18px;
  color: #00ff88;
}

button {
  width: 100%;
  padding: 10px 0;
  margin-bottom: 12px;
  background: #00ff88;
  color: #121212;
  font-weight: bold;
  font-size: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

button:hover {
  background: #00cc66;
}

button:disabled {
  background: #555;
  cursor: not-allowed;
}

#status {
  font-size: 14px;
  margin-bottom: 12px;
  color: #cccccc;
}

textarea {
  width: 100%;
  height: 320px;
  background: #0b0b0b;
  color: #00ff88;
  border: none;
  border-radius: 8px;
  padding: 8px;
  resize: vertical;
  font-family: 'Fira Code', monospace;
  font-size: 13px;
  line-height: 1.4em;
  overflow-y: auto;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" width="640" height="360"></canvas>

<div id="ui">
  <h2>Pose Mocap Recorder</h2>
  <button id="record">Record 10s Mocap</button>
  <div id="status">Status: Idle</div>
  <textarea id="output" placeholder="Generated Roblox Lua will appear here..."></textarea>
</div>

<script type="module">
import { FilesetResolver, PoseLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const output = document.getElementById("output");
const recordBtn = document.getElementById("record");
const statusLabel = document.getElementById("status");

let landmarker;
let recording = false;
let frames = [];
let lastDetect = 0;
const DETECT_INTERVAL = 33;

async function init() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { width: { ideal: 640 }, height: { ideal: 360 }, frameRate: { ideal: 30, max: 30 } }
  });
  video.srcObject = stream;
  await video.play();

  const resolver = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm"
  );

  landmarker = await PoseLandmarker.createFromOptions(resolver, {
    baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task" },
    runningMode: "VIDEO",
    numPoses: 1
  });

  requestAnimationFrame(loop);
}

// Canvas helpers
function px(lm){ return {x: lm.x*canvas.width, y: lm.y*canvas.height}; }
function drawLine(a,b,color="#0f0"){ const p1=px(a),p2=px(b); ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); }
function drawBox(indices,lm,color="#00ffff"){ const xs=indices.map(i=>px(lm[i]).x),ys=indices.map(i=>px(lm[i]).y); ctx.strokeStyle=color; ctx.lineWidth=2; ctx.strokeRect(Math.min(...xs),Math.min(...ys),Math.max(...xs)-Math.min(...xs),Math.max(...ys)-Math.min(...ys)); }

function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const now=performance.now();
  let result=null;
  if(now-lastDetect>=DETECT_INTERVAL){
    result=landmarker.detectForVideo(video,now);
    lastDetect=now;
  }

  if(result?.poseLandmarks?.[0]){
    const lm=result.poseLandmarks[0];
    const connections=[[11,13],[13,15],[12,14],[14,16],[23,25],[25,27],[24,26],[26,28],[11,12],[11,23],[12,24],[23,24]];
    connections.forEach(c=>drawLine(lm[c[0]],lm[c[1]],"#0f0"));

    drawBox([11,12,23,24],lm,"#00ffff");
    drawBox([11,13,15],lm,"#ff00ff");
    drawBox([12,14,16],lm,"#ff00ff");
    drawBox([23,25,27],lm,"#ffff00");
    drawBox([24,26,28],lm,"#ffff00");
  }

  if(recording && result?.worldLandmarks?.[0]) frames.push(result.worldLandmarks[0]);
  requestAnimationFrame(loop);
}

function vec(a,b){ return {x:b.x-a.x,y:b.y-a.y,z:b.z-a.z}; }
function toEuler(v){ const yaw=Math.atan2(v.x,v.z)*180/Math.PI; const pitch=-Math.atan2(v.y,Math.sqrt(v.x*v.x+v.z*v.z))*180/Math.PI; return `Vector3.new(${pitch.toFixed(1)},${yaw.toFixed(1)},0)`; }

recordBtn.onclick=async()=>{
  frames=[]; recording=true;
  recordBtn.disabled=true; statusLabel.textContent="Status: Recording...";
  await new Promise(r=>setTimeout(r,10000));
  recording=false; recordBtn.disabled=false; statusLabel.textContent="Status: Idle";
  exportLua();
};

function exportLua(){
  let lua=""; const dt=(1/30).toFixed(3);
  frames.forEach((p,i)=>{
    lua+=`local function kf${i+1}()\n`;
    const joints={LeftUpperArm:vec(p[11],p[13]),LeftLowerArm:vec(p[13],p[15]),RightUpperArm:vec(p[12],p[14]),RightLowerArm:vec(p[14],p[16]),LeftUpperLeg:vec(p[23],p[25]),LeftLowerLeg:vec(p[25],p[27]),RightUpperLeg:vec(p[24],p[26]),RightLowerLeg:vec(p[26],p[28])};
    for(const j in joints) lua+=`  ${j}.Orientation=${toEuler(joints[j])}\n`;
    lua+="end\n\n";
  });
  frames.forEach((_,i)=>{ lua+=`kf${i+1}()\ntask.wait(${dt})\n`; });
  output.value=lua;
}

init();
</script>
</body>
</html>
