<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pose to Roblox Keyframes</title>

<style>
body {
  background: #0b0b0b;
  color: #e0e0e0;
  font-family: monospace;
}
video, canvas {
  position: absolute;
  top: 0;
  left: 0;
}
#ui {
  position: fixed;
  right: 10px;
  top: 10px;
  width: 420px;
}
button {
  width: 100%;
  padding: 10px;
  margin-bottom: 8px;
}
textarea {
  width: 100%;
  height: 420px;
  background: #000;
  color: #00ff88;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<div id="ui">
  <button onclick="captureKeyframe()">Capture Keyframe</button>
  <textarea id="output"></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const output = document.getElementById("output");

let lastPose = null;
let frame = 0;
let luaText = "";

const pose = new Pose({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
});

pose.setOptions({
  modelComplexity: 2,
  smoothLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults(r => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(r.image, 0, 0);
  if (r.poseLandmarks) {
    drawConnectors(ctx, r.poseLandmarks, POSE_CONNECTIONS);
    drawLandmarks(ctx, r.poseLandmarks);
    lastPose = r.poseLandmarks;
  }
});

new Camera(video, {
  onFrame: async () => {
    await pose.send({ image: video });
  },
  width: 1280,
  height: 720
}).start();

function vec(a, b) {
  return { x: b.x - a.x, y: b.y - a.y, z: b.z - a.z };
}

function toCFrame(v) {
  const yaw = Math.atan2(v.x, v.z);
  const pitch = -Math.atan2(v.y, Math.sqrt(v.x*v.x + v.z*v.z));
  return `CFrame.Angles(${pitch.toFixed(3)}, ${yaw.toFixed(3)}, 0)`;
}

function captureKeyframe() {
  if (!lastPose) return;

  frame++;
  const p = lastPose;

  const joints = {
    LeftShoulder: vec(p[11], p[13]),
    LeftElbow: vec(p[13], p[15]),
    RightShoulder: vec(p[12], p[14]),
    RightElbow: vec(p[14], p[16]),
    LeftHip: vec(p[23], p[25]),
    LeftKnee: vec(p[25], p[27]),
    RightHip: vec(p[24], p[26]),
    RightKnee: vec(p[26], p[28])
  };

  luaText += `local function kf${frame}()\n`;
  for (const j in joints) {
    luaText += `  ${j}.Transform = ${toCFrame(joints[j])}\n`;
  }
  luaText += `end\n`;
  luaText += `kf${frame}()\n`;
  luaText += `task.wait(0.033)\n\n`;

  output.value = luaText;
}
</script>

</body>
</html>
