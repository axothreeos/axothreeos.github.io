<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Adaptive Hand Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

#app {
  position: relative;
  width: 100%;
  height: 100%;
}

video, canvas {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#startBtn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 16px 26px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  background: #00ff88;
  z-index: 10;
}

#hud {
  position: absolute;
  top: 12px;
  left: 12px;
  color: white;
  background: rgba(0,0,0,0.55);
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 5;
}

#hud button {
  margin-top: 6px;
  width: 100%;
  background: #222;
  color: white;
  border: none;
  padding: 6px;
  border-radius: 6px;
}

#status {
  font-size: 12px;
  opacity: 0.8;
}
</style>
</head>
<body>

<div id="app">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <button id="startBtn">Start Camera</button>

  <div id="hud">
    Fingers: <span id="fingerCount">0</span><br>
    <span id="status">Idle</span><br>
    <button id="calibrateBtn">Calibrate</button>
    <button id="resetBtn">Reset Learning</button>
  </div>
</div>

<script>
const video = document.getElementById("video")
const canvas = document.getElementById("canvas")
const ctx = canvas.getContext("2d")

const startBtn = document.getElementById("startBtn")
const fingerLabel = document.getElementById("fingerCount")
const statusLabel = document.getElementById("status")
const calibrateBtn = document.getElementById("calibrateBtn")
const resetBtn = document.getElementById("resetBtn")

let heatMap
let smoothedFingers = 0
let calibrating = false

let avgSkin = JSON.parse(localStorage.getItem("avgSkin")) || {
  r: 140,
  g: 100,
  b: 90
}

function saveSkin() {
  localStorage.setItem("avgSkin", JSON.stringify(avgSkin))
}

function resize() {
  canvas.width = video.videoWidth
  canvas.height = video.videoHeight
  heatMap = new Float32Array(canvas.width * canvas.height)
}

function isSkin(r, g, b) {
  return (
    Math.abs(r - avgSkin.r) < 45 &&
    Math.abs(g - avgSkin.g) < 45 &&
    Math.abs(b - avgSkin.b) < 45
  )
}

startBtn.onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    })
    video.srcObject = stream
    video.onloadedmetadata = () => {
      video.play()
      resize()
      startBtn.style.display = "none"
      statusLabel.textContent = "Running"
      requestAnimationFrame(loop)
    }
  } catch (e) {
    alert(e.name + ": " + e.message)
  }
}

calibrateBtn.onclick = () => {
  calibrating = true
  statusLabel.textContent = "Calibrating"
}

resetBtn.onclick = () => {
  avgSkin = { r: 140, g: 100, b: 90 }
  saveSkin()
  statusLabel.textContent = "Learning reset"
}

function loop() {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
  const img = ctx.getImageData(0, 0, canvas.width, canvas.height)
  const data = img.data

  let minX = canvas.width
  let minY = canvas.height
  let maxX = 0
  let maxY = 0

  let sumR = 0
  let sumG = 0
  let sumB = 0
  let count = 0

  for (let i = 0; i < data.length; i += 4) {
    const idx = i / 4
    const r = data[i]
    const g = data[i + 1]
    const b = data[i + 2]

    heatMap[idx] *= 0.97

    if (isSkin(r, g, b) || calibrating) {
      heatMap[idx] += 1

      if (heatMap[idx] > 3) {
        const x = idx % canvas.width
        const y = Math.floor(idx / canvas.width)

        minX = Math.min(minX, x)
        minY = Math.min(minY, y)
        maxX = Math.max(maxX, x)
        maxY = Math.max(maxY, y)

        sumR += r
        sumG += g
        sumB += b
        count++
      }
    }
  }

  if (count > 400) {
    const lr = calibrating ? 0.15 : 0.02

    avgSkin.r += (sumR / count - avgSkin.r) * lr
    avgSkin.g += (sumG / count - avgSkin.g) * lr
    avgSkin.b += (sumB / count - avgSkin.b) * lr

    if (calibrating) {
      saveSkin()
      calibrating = false
      statusLabel.textContent = "Calibrated"
    }

    ctx.strokeStyle = "#00ff88"
    ctx.lineWidth = 3
    ctx.strokeRect(minX, minY, maxX - minX, maxY - minY)

    const fingers = estimateFingers(minX, minY, maxX, maxY)
    smoothedFingers += (fingers - smoothedFingers) * 0.25
    fingerLabel.textContent = Math.round(smoothedFingers)
  } else {
    fingerLabel.textContent = "0"
  }

  requestAnimationFrame(loop)
}

function estimateFingers(minX, minY, maxX, maxY) {
  const w = maxX - minX
  const h = maxY - minY
  if (w <= 0 || h <= 0) return 0

  const img = ctx.getImageData(minX, minY, w, h).data
  const projection = new Array(w).fill(0)

  for (let y = 0; y < h * 0.4; y++) {
    for (let x = 0; x < w; x++) {
      const i = (y * w + x) * 4
      if (isSkin(img[i], img[i + 1], img[i + 2])) {
        projection[x]++
      }
    }
  }

  let fingers = 0
  for (let i = 1; i < projection.length - 1; i++) {
    if (
      projection[i] > projection[i - 1] &&
      projection[i] > projection[i + 1] &&
      projection[i] > h * 0.06
    ) {
      fingers++
    }
  }

  return Math.min(fingers, 5)
}
</script>

</body>
</html>
