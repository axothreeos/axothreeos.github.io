<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pose Landmarker to Roblox</title>

<style>
body {
  background: #0b0b0b;
  color: #e0e0e0;
  font-family: monospace;
}
video, canvas {
  position: absolute;
  top: 0;
  left: 0;
}
#ui {
  position: fixed;
  right: 10px;
  top: 10px;
  width: 420px;
}
button {
  width: 100%;
  padding: 10px;
  margin-bottom: 8px;
}
textarea {
  width: 100%;
  height: 420px;
  background: #000;
  color: #00ff88;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<div id="ui">
  <button id="capture">Capture Keyframe</button>
  <textarea id="output"></textarea>
</div>

<script type="module">
import {
  FilesetResolver,
  PoseLandmarker
} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const output = document.getElementById("output");
const captureBtn = document.getElementById("capture");

let landmarker;
let lastWorldLandmarks = null;
let frame = 0;
let luaText = "";

async function init() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  await video.play();

  const resolver = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm"
  );

  landmarker = await PoseLandmarker.createFromOptions(resolver, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task"
    },
    runningMode: "VIDEO",
    numPoses: 1
  });

  requestAnimationFrame(loop);
}

function loop() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  const now = performance.now();
  const result = landmarker.detectForVideo(video, now);

  if (result.worldLandmarks && result.worldLandmarks[0]) {
    lastWorldLandmarks = result.worldLandmarks[0];
  }

  requestAnimationFrame(loop);
}

function vec(a, b) {
  return {
    x: b.x - a.x,
    y: b.y - a.y,
    z: b.z - a.z
  };
}

function toCFrame(v) {
  const yaw = Math.atan2(v.x, v.z);
  const pitch = -Math.atan2(v.y, Math.sqrt(v.x * v.x + v.z * v.z));
  return `CFrame.Angles(${pitch.toFixed(3)}, ${yaw.toFixed(3)}, 0)`;
}

captureBtn.onclick = () => {
  if (!lastWorldLandmarks) return;

  frame++;

  const p = lastWorldLandmarks;

  const joints = {
    LeftShoulder: vec(p[11], p[13]),
    LeftElbow: vec(p[13], p[15]),
    RightShoulder: vec(p[12], p[14]),
    RightElbow: vec(p[14], p[16]),
    LeftHip: vec(p[23], p[25]),
    LeftKnee: vec(p[25], p[27]),
    RightHip: vec(p[24], p[26]),
    RightKnee: vec(p[26], p[28])
  };

  luaText += `local function kf${frame}()\n`;
  for (const j in joints) {
    luaText += `  ${j}.Transform = ${toCFrame(joints[j])}\n`;
  }
  luaText += `end\n`;
  luaText += `kf${frame}()\n`;
  luaText += `task.wait(0.033)\n\n`;

  output.value = luaText;
};

init();
</script>

</body>
</html>
